<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jampæ™ºèƒ½èŠå¤©å®¤</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="chat-header">
            <div class="header-left">
                <h2 class="logo-small">Jamp <span>æ™ºèƒ½èŠå¤©å®¤</span></h2>
            </div>
            <div class="header-right">
                <span class="current-user">å½“å‰ç”¨æˆ·: <span id="current-username">{{ username }}</span></span>
                <button id="logout-btn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡º
                </button>
            </div>
        </div>
        
        <div class="chat-content">
            <!-- å·¦ä¾§æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages">
                <div id="messages-container" class="messages-container">
                    <div class="system-message">
                        <p>æ¬¢è¿æ¥åˆ°Jampæ™ºèƒ½èŠå¤©å®¤ï¼</p>
                        <p>ä½¿ç”¨æŒ‡å—ï¼š</p>
                        <ul>
                            <li>å‘é€æ–‡æœ¬æ¶ˆæ¯å’ŒEmojiè¡¨æƒ…</li>
                            <li>ä½¿ç”¨@ç”¨æˆ·åè¿›è¡Œæé†’</li>
                            <li>ä½¿ç”¨@ç”µå½± urlåˆ†äº«ç”µå½±é“¾æ¥</li>
                            <li>ä½¿ç”¨@å·å°å†œ æé—®ä¸AIå¯¹è¯</li>
                        </ul>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
                <div class="message-input-area">
                    <div class="input-toolbar">
                        <button id="emoji-btn" class="toolbar-btn" title="Emojiè¡¨æƒ…">
                            <i class="far fa-smile"></i>
                        </button>
                        <button id="help-btn" class="toolbar-btn" title="ä½¿ç”¨å¸®åŠ©">
                            <i class="far fa-question-circle"></i>
                        </button>
                    </div>
                    <form id="message-form" class="message-form">
                        <input 
                            type="text" 
                            id="message-input" 
                            placeholder="è¾“å…¥æ¶ˆæ¯... æ”¯æŒ@åŠŸèƒ½: @ç”¨æˆ·å, @ç”µå½± url, @å·å°å†œ é—®é¢˜"
                            autocomplete="off"
                        >
                        <button type="submit" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- å³ä¾§ç”¨æˆ·åˆ—è¡¨ -->
            <div class="chat-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-users"></i> åœ¨çº¿ç”¨æˆ·</h3>
                    <span id="online-count" class="online-count">0</span>
                </div>
                <div id="users-list" class="users-list">
                    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emojié€‰æ‹©å™¨ï¼ˆéšè—çŠ¶æ€ï¼‰ -->
    <div id="emoji-picker" class="emoji-picker hidden">
        <div class="emoji-grid">
            <!-- å¸¸ç”¨Emojiï¼Œæ¯ä¸ªè¡¨æƒ…å•ç‹¬åŒ…è£…åœ¨spanæ ‡ç­¾ä¸­ -->
            <span>ğŸ˜€</span><span>ğŸ˜ƒ</span><span>ğŸ˜„</span><span>ğŸ˜</span><span>ğŸ˜†</span><span>ğŸ˜…</span><span>ğŸ˜‚</span><span>ğŸ¤£</span>
            <span>ğŸ˜Š</span><span>ğŸ˜‡</span><span>ğŸ™‚</span><span>ğŸ™ƒ</span><span>ğŸ˜‰</span><span>ğŸ˜Œ</span><span>ğŸ˜</span><span>ğŸ¥°</span>
            <span>ğŸ˜˜</span><span>ğŸ˜—</span><span>ğŸ˜™</span><span>ğŸ˜š</span><span>ğŸ˜‹</span><span>ğŸ˜›</span><span>ğŸ˜</span><span>ğŸ˜œ</span>
            <span>ğŸ¤ª</span><span>ğŸ¤¨</span><span>ğŸ§</span><span>ğŸ¤“</span><span>ğŸ˜</span><span>ğŸ¤©</span><span>ğŸ¥³</span><span>ğŸ˜</span>
            <span>ğŸ˜’</span><span>ğŸ˜</span><span>ğŸ˜”</span><span>ğŸ˜Ÿ</span><span>ğŸ˜•</span><span>ğŸ™</span><span>â˜¹ï¸</span><span>ğŸ˜£</span>
            <span>ğŸ˜–</span><span>ğŸ˜«</span><span>ğŸ˜©</span><span>ğŸ¥º</span><span>ğŸ˜¢</span><span>ğŸ˜­</span><span>ğŸ˜¤</span><span>ğŸ˜ </span>
            <span>ğŸ˜¡</span><span>ğŸ¤¬</span><span>ğŸ¤¯</span><span>ğŸ˜³</span><span>ğŸ¥µ</span><span>ğŸ¥¶</span><span>ğŸ˜±</span><span>ğŸ˜¨</span>
            <span>ğŸ˜°</span><span>ğŸ˜¥</span><span>ğŸ˜“</span><span>ğŸ¤—</span><span>ğŸ¤”</span><span>ğŸ¤­</span><span>ğŸ¤«</span><span>ğŸ¤¥</span>
            <span>ğŸ˜¶</span><span>ğŸ˜</span><span>ğŸ˜‘</span><span>ğŸ˜¬</span><span>ğŸ™„</span><span>ğŸ˜¯</span><span>ğŸ˜¦</span><span>ğŸ˜§</span>
            <span>ğŸ˜®</span><span>ğŸ˜²</span><span>ğŸ¥±</span><span>ğŸ˜´</span><span>ğŸ¤¤</span><span>ğŸ˜ª</span><span>ğŸ˜µ</span><span>ğŸ¤</span>
            <span>ğŸ¥´</span><span>ğŸ¤¢</span><span>ğŸ¤®</span><span>ğŸ¤§</span><span>ğŸ˜·</span><span>ğŸ¤’</span><span>ğŸ¤•</span><span>ğŸ¤‘</span>
            <span>ğŸ¤ </span><span>ğŸ˜ˆ</span><span>ğŸ‘¿</span><span>ğŸ‘¹</span><span>ğŸ‘º</span><span>ğŸ¤¡</span><span>ğŸ’©</span><span>ğŸ‘»</span>
            <span>ğŸ’€</span><span>â˜ ï¸</span><span>ğŸ‘½</span><span>ğŸ‘¾</span><span>ğŸ¤–</span><span>ğŸƒ</span><span>ğŸ˜º</span><span>ğŸ˜¸</span>
            <span>ğŸ˜¹</span><span>ğŸ˜»</span><span>ğŸ˜¼</span><span>ğŸ˜½</span><span>ğŸ™€</span><span>ğŸ˜¿</span><span>ğŸ˜¾</span>
        </div>
    </div>
    
    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="help-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä½¿ç”¨å¸®åŠ©</h3>
                <button id="close-help" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <h4>åŸºç¡€åŠŸèƒ½ï¼š</h4>
                <ul>
                    <li>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬æ¶ˆæ¯å¹¶æŒ‰Enterå‘é€</li>
                    <li>ç‚¹å‡»ğŸ˜ŠæŒ‰é’®é€‰æ‹©å¹¶å‘é€Emojiè¡¨æƒ…</li>
                    <li>å³ä¾§æ˜¾ç¤ºå½“å‰åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</li>
                </ul>
                <h4>ç‰¹æ®ŠåŠŸèƒ½ï¼š</h4>
                <ul>
                    <li><strong>@ç”¨æˆ·å</strong> - æé†’ç‰¹å®šç”¨æˆ·ï¼Œå¦‚ï¼š@å°æ˜ ä½ å¥½</li>
                    <li><strong>@ç”µå½± url</strong> - åˆ†äº«ç”µå½±é“¾æ¥ï¼Œæ”¯æŒè§£æåœ°å€å¹¶æ’­æ”¾ï¼Œå¦‚ï¼š@ç”µå½± https://example.com/video.mp4</li>
                    <li><strong>@å·å°å†œ é—®é¢˜</strong> - ä¸AIåŠ©æ‰‹å·å°å†œå¯¹è¯ï¼Œå¦‚ï¼š@å·å°å†œ ä½ å¥½</li>
                </ul>
                <h4>å·å°å†œæœºå™¨äººåŠŸèƒ½ï¼š</h4>
                <ul>
                    <li>å§‹ç»ˆåœ¨çº¿ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</li>
                    <li>åœ¨æ‚¨åŠ å…¥èŠå¤©å®¤æ—¶è‡ªåŠ¨æ¬¢è¿</li>
                    <li>å“åº”@æ¶ˆæ¯ï¼Œæä¾›æ™ºèƒ½å›å¤</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const username = '{{ username }}';
            const socket = io();
            
            // DOMå…ƒç´ 
            const messagesContainer = document.getElementById('messages-container');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const usersList = document.getElementById('users-list');
            const onlineCount = document.getElementById('online-count');
            const logoutBtn = document.getElementById('logout-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const closeHelp = document.getElementById('close-help');
            
            // è¿æ¥Socket.IOå¹¶åŠ å…¥èŠå¤©å®¤
            socket.on('connect', function() {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                socket.emit('join', { username: username });
            });
            
            // æ¥æ”¶æ¬¢è¿æ¶ˆæ¯
            socket.on('welcome_message', function(data) {
                addSystemMessage(data.message);
                updateOnlineUsers(data.online_users);
            });
            
            // æ¥æ”¶æ–°æ¶ˆæ¯
            socket.on('new_message', function(data) {
                addMessage(data);
            });
            
            // æ¥æ”¶ç”¨æˆ·åŠ å…¥æ¶ˆæ¯
            socket.on('user_joined', function(data) {
                addSystemMessage(`${data.username} åŠ å…¥äº†èŠå¤©å®¤`);
                updateOnlineUsers(data.online_users);
            });
            
            // æ¥æ”¶ç”¨æˆ·ç¦»å¼€æ¶ˆæ¯
            socket.on('user_left', function(data) {
                addSystemMessage(`${data.username} ç¦»å¼€äº†èŠå¤©å®¤`);
                updateOnlineUsers(data.online_users);
            });
            
            // è¡¨å•æäº¤å¤„ç†
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (message) {
                    socket.emit('send_message', { message: message });
                    messageInput.value = '';
                }
            });
            
            // é€€å‡ºæŒ‰é’®å¤„ç†
            logoutBtn.addEventListener('click', function() {
                socket.emit('leave');
                window.location.href = '/';
            });
            
            // Emojié€‰æ‹©å™¨
            emojiBtn.addEventListener('click', function() {
                emojiPicker.classList.toggle('hidden');
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­Emojié€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // é€‰æ‹©Emoji
            const emojiGrid = emojiPicker.querySelector('.emoji-grid');
            emojiGrid.addEventListener('click', function(e) {
                if (e.target.textContent) {
                    messageInput.value += e.target.textContent;
                    messageInput.focus();
                }
            });
            
            // å¸®åŠ©å¼¹çª—
            helpBtn.addEventListener('click', function() {
                helpModal.classList.remove('hidden');
            });
            
            closeHelp.addEventListener('click', function() {
                helpModal.classList.add('hidden');
            });
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === helpModal) {
                    helpModal.classList.add('hidden');
                }
            });
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            function addMessage(data) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ·»åŠ ä¸åŒæ ·å¼
                if (data.is_system) {
                    messageElement.classList.add('system-message');
                } else if (data.is_ai) {
                    messageElement.classList.add('ai-message');
                } else if (data.username === username) {
                    messageElement.classList.add('my-message');
                } else {
                    messageElement.classList.add('other-message');
                }
                
                // æ„å»ºæ¶ˆæ¯å†…å®¹
                let messageHTML = '';
                if (!data.is_system) {
                    const isBot = data.username === 'å·å°å†œ';
                    messageHTML += `<div class="message-header">
                        <span class="message-username ${isBot ? 'bot-username' : ''}">${data.username}${isBot ? ' ğŸ¤–' : ''}</span>
                        <span class="message-time">${data.timestamp}</span>
                    </div>`;
                }
                
                // å¤„ç†ç”µå½±é“¾æ¥
                if (data.is_movie && data.movie_url) {
                    messageHTML += `<div class="message-content movie-message">
                        <p>ğŸ¬ ç”µå½±é“¾æ¥ï¼š<a href="${data.movie_url}" target="_blank">${data.movie_url}</a></p>
                        <!-- ç”µå½±æ’­æ”¾å™¨ -->
                        <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;">
                            <iframe 
                                src="${data.movie_url}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1;">
                            </iframe>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">å¦‚æœè§†é¢‘æ— æ³•æ’­æ”¾ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€</div>
                    </div>`;
                } else {
                    // å¤„ç†@æé†’ï¼Œæ·»åŠ é«˜äº®
                    let content = data.message;
                    if (content.includes('@')) {
                        content = content.replace(/@(\w+)/g, function(match, username) {
                            return `<span class="mention">${match}</span>`;
                        });
                    }
                    messageHTML += `<div class="message-content">${content}</div>`;
                }
                
                messageElement.innerHTML = messageHTML;
                messagesContainer.appendChild(messageElement);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
            }
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            function addSystemMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'system-message');
                messageElement.innerHTML = `<div class="message-content">${message}</div>`;
                messagesContainer.appendChild(messageElement);
                scrollToBottom();
            }
            
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            function updateOnlineUsers(users) {
                usersList.innerHTML = '';
                onlineCount.textContent = users.length;
                
                users.forEach(function(user) {
                    const userElement = document.createElement('div');
                    userElement.classList.add('user-item');
                    const isBot = user === 'å·å°å†œ';
                    
                    if (user === username) {
                        userElement.classList.add('current-user-item');
                        userElement.innerHTML = `
                            <span class="user-status online"></span>
                            <span class="user-name">${user} (ä½ )</span>
                        `;
                    } else {
                        userElement.innerHTML = `
                            <span class="user-status online ${isBot ? 'bot-status' : ''}"></span>
                            <span class="user-name ${isBot ? 'bot-name' : ''}">${user}${isBot ? ' ğŸ¤–' : ''}</span>
                        `;
                    }
                    
                    // æ·»åŠ ç‚¹å‡»ç”¨æˆ·åæ’å…¥@åŠŸèƒ½
                    userElement.addEventListener('click', function() {
                        messageInput.value += ' @' + user;
                        messageInput.focus();
                    });
                    
                    usersList.appendChild(userElement);
                });
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // ç›‘å¬æŒ‰é”®äº‹ä»¶ï¼Œæ”¯æŒEnterå‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    messageForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // ç›‘å¬çª—å£å…³é—­äº‹ä»¶ï¼Œå‘é€ç¦»å¼€æ¶ˆæ¯
            window.addEventListener('beforeunload', function() {
                socket.emit('leave');
            });
        });
    </script>
</body>
</html>